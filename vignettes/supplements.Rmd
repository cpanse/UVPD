---
title: "supplements"
author: "AB/CP"
date: "5/6/2020"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(lattice)
```

## Compose

* run `20200416.R`

```{r eval=FALSE}
library(readr)
file_group <- read_csv("file-group.csv")
FG <- file_group[paste(file_group$file, ".raw",sep='') %in% X20200423_uvpd$filename, ]
FG$file <- paste(FG$file, '.raw', sep='')


GS <- data.frame(group=ThermoUVPD_feb2019$Group, SMILES=ThermoUVPD_feb2019$SMILES)
GSF <- merge(GS, FG, by='group')

X20200423_uvpd$m <- paste(X20200423_uvpd$filename, X20200423_uvpd$SMILES)

GSF$m <- paste(GSF$file, GSF$SMILES)


X20200423 <- merge(GSF, X20200423_uvpd, by='m')

```


## Load
```{r}
load(file.path(system.file(package = 'uvpd'), "/extdata/X20200423.RData"))
```


## Sanity check

negative mode

```{r}
knitr::kable(table(X20200423$file[X20200423$mode < 0], X20200423$Group[X20200423$mode < 0]))
```

one substance seems to be part of multiple groups!

positive mode

```{r}
knitr::kable(table(X20200423$file[X20200423$mode > 0], X20200423$Group[X20200423$mode > 0]))
```

lets exclude `"4-Chlorobenzoic acid"`

```{r}
X <- X20200423[!(X20200423$Compound=="4-Chlorobenzoic acid"), ]
knitr::kable(table(X$file[X$mode < 0], X$Group[X$mode < 0]))
knitr::kable(table(X$file[X$mode > 0], X$Group[X$mode > 0]))
```

```{r}
xyplot(log(tic) ~ log(master.intensity) | Compound, groups = fragmode, data=X20200423, pch='.')
```

```{r}
knitr::kable(head(X))
```
master intensity =def= masterscan (MS1) isolated precursor m/z intensity in a given mass window +- 0.01 Da.

find three best matches acc. highest master intensity

```{r determinetop3}
# theoretic possible combinations
cc <- expand.grid(as.character(unique(X$file)), as.character(unique(X$SMILES.x)), as.character(unique(X$fragmode)))
names(cc) <- c('file', 'SMILES', 'fragmode')
cc <- paste(cc$file, cc$SMILES, cc$fragmode)

# this is the real world
X$m <- paste(X$file, X$SMILES.x, X$fragmode)

 library(parallel)
X.top3.master.intensity <- do.call('rbind', lapply(cc, function(m){
    XX <- X[X$m == m, ]
    XX <- XX[order(XX$master.intensity, decreasing = TRUE), ]
    n <- nrow(XX)
    
    if (nrow(XX) > 2){
        return(XX[1:3, ])}
    else if (n > 0){
        return(XX[1:n, ])}
    else{return(NULL)}
}))

X.top3.tic <- do.call('rbind', lapply(cc, function(m){
    XX <- X[X$m == m, ]
    XX <- XX[order(XX$tic, decreasing = TRUE), ]
    n <- nrow(XX)
    
    if (nrow(XX) > 2){
        return(XX[1:3, ])}
    else if (n > 0){
        return(XX[1:n, ])}
    else{return(NULL)}
}))

```

```{r eval=FALSE}
table(X.top3.master.intensity$file)
table(X.top3.master.intensity$SMILES.x)
table(X.top3.master.intensity$fragmode)
```

```{r}
image(as.matrix(table(X.top3.master.intensity$file, X.top3.master.intensity$fragmode)))
```


compare pos versus negative
TODO(CP): order by reacion time / ce
```{r eval=TRUE}
library(lattice);

lp <- bwplot(log(master.intensity / tic) ~ as.character(mode) | as.factor(fragmode), 
        data=X.top3.master.intensity, horizontal = F)

lp <- bwplot(log(master.intensity / tic) ~ as.character(mode) | as.factor(fragmode), 
        data=X.top3.tic, horizontal = F)
```

```{r}
plot(X.top3.tic$scan , X.top3.master.intensity$scan)
```


# 
```{r}
load(file.path(system.file(package = 'uvpd'), "/extdata/extractedMs2Feature.RData"))
# load("../inst/extdata/extractedMs2Feature.RData")
Castell <- do.call('rbind', uvpd.Castell)

Castell$scanTypeFilter <- gsub("@uvpd50.00", "@uvpd050.00", Castell$scanTypeFilter)

Castell$scanTypeFilter <- gsub("@uvpd25.00", "@uvpd025.00", Castell$scanTypeFilter)

Castell$rawfile <- basename(Castell$rawfile)
```

filter use only top3
```{r}
ff <- (paste(Castell$scan, Castell$rawfile) %in% paste(X.top3.master.intensity$scan, X.top3.master.intensity$filename))
```


```{r}
library(ggplot2)
Castell.ff  <- aggregate(intensity ~ mZ * rawfile * scanTypeFilter * SMILES0 * formula * formula0 * type, data=Castell[ff,], FUN=sum)
dim(Castell)
dim(Castell.ff)
lapply(unique(Castell.ff$formula0), function(f){
    df <- Castell.ff[Castell.ff$formula0 == f, ]
    
    gp <- ggplot(data = df, aes(x=scanTypeFilter,
                                y=log(intensity, 10),  fill=formula)) +
       geom_bar(stat="identity") +
        theme(axis.text.x = element_text(angle = 90, hjust = 1)) +
        facet_wrap(~ formula0)
    #gp + facet_wrap(~ grepl("uvpd", df$scanTypeFilter))
   #gp + facet_wrap(~ grepl("uvpd", Castell_sum$scanTypeFilter))
})

```

# fetch MS2
```{r}
library(MsBackendRawFileReader)

X.top3.master.intensity.MS2.profile <- lapply(sort(unique(X.top3.master.intensity$file)), function(f){
    sn <- X.top3.master.intensity$scan[X.top3.master.intensity$file==f]
    
    rawfile <- file.path('/Users/cp/Downloads/p2722/', f)
    message(rawfile)
    x <- .cnew ("Rawfile", rawfile)
    
    rv <- lapply(sn, function(i){
        mZ <- x$GetSpectrumMasses(i)
        intensity <- x$GetSpectrumIntensities(i)
        rv <- data.frame(mZ=mZ, intensity=intensity)
        rv$file <- f
        rv$scan <- i
        rv
    })
    rv
})

```


```{r}
load(file.path(system.file(package = 'uvpd'), "/extdata/fragments.RData"))

```


```{r}

X.top3.master.intensity.MS2.centroid <- lapply(sort(unique(X.top3.master.intensity$file))[22], function(f){
    sn <- X.top3.master.intensity$scan[X.top3.master.intensity$file==f]
    sm <- X.top3.master.intensity$SMILES.x[X.top3.master.intensity$file==f]
    cm <- X.top3.master.intensity$Compound[X.top3.master.intensity$file==f]
    rawfile <- file.path('/Users/cp/Downloads/p2722/', f)
    message(rawfile)
    x <- .cnew ("Rawfile", rawfile)
    
    rv <- mapply(function(scan, smile){
        mZ <- x$GetSpectrumMasses(scan)
        intensity <- x$GetSpectrumIntensities(scan)
        
        cc <- protViz::centroid(mZ, intensity)
        
        rv <- data.frame(mZ=cc$mZ, intensity=cc$intensity)
        
        idx <- which(fragments.treeDepth2$SMILES == as.character(smile))
        
        # computed by MetFrag
        insilico <- fragments.treeDepth1$ms2[[idx]]
        insilico <- insilico[!is.na(insilico$mZ),]
        
        # determine best match
        NN <- findNN(cc$mZ, insilico$mZ)
        eps <- insilico$mZ[NN] - cc$mZ 
        ppmerror <- (eps /  insilico$mZ[NN]) * 1000000
        
        fff <- abs(eps) < 0.01
        message(paste(sum(fff), "/", length(cc$mZ), "intensity coverage", round(sum(cc$intensity[fff])/sum(cc$intensity),2)))
        
        rv$file <- f
        rv$formula <- insilico$formula[NN]
        rv$compound <- compound
        rv$type <- insilico$type[NN]
        rv$eps <- eps
        rv$ppmerror <- ppmerror
        rv$scan <- scan
        #rv$SMILE <- smile
        #rv[abs(rv$eps) < 0.01,]
        rv
    }, scan=sn, smile=sm, compound=cm, SIMPLIFY = FALSE)
    rv
})
```

TODO(AB): check pos/neg mode in in-silico fragments