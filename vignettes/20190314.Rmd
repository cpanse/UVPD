---
title: "Computer in-silico fragment and match"
author: "AB/CP"
output:
  html_document:
    toc_float: true
    toc: true
    number_sections: true
    theme: united
bibliography: uvpd.bib
---

# 2019-03-14 

session @ fgcz, AB/CP

- site note: Metabolmics 


TODO:

- MetFragR R package https://github.com/ipb-halle/MetFragR
  * compute in-silico fragments (CP)
  
https://github.com/ipb-halle/MetFragR/blob/9e482f6f6cb3cb6aa07af779d9acc7d6ff757f5f/metfRag/R/fragment.R#L11


```{r}
library(metfRag)

smiles <- "CC(C)(C)C(O)C(OC1=CC=C(Cl)C=C1)N1C=NC=N1"
molecule<-parse.smiles(smiles)[[1]]

#calculate the fragments
fragments <- frag.generateFragments(molecule, 1)

length(fragments)

```

- Input: 
 
 
```{r}
library(uvpd)
library(rawDiag)
#rawfile <- "/Users/cp/data/stds_pos_neg_MS_highconc_UVPD_50_300.raw"
(rawfile <- file.path(Sys.getenv('HOME'), "Downloads",
  "stds_pos_neg_MS_highconc_UVPD_50_300.raw"))
RAW <- read.raw(rawfile, rawDiag = TRUE)
```


```{r}
 table(RAW$MSOrder)
```


## Input


### Get XIC

```{r}
mz <- 296.116
	
XIC <- readXICs(rawfile, mz)

plot(XIC)
```


### Get Ms2 Scannumbers

```{r}
eps <- 0.01; 
sn <-RAW$scanNumber[which(mz-eps < RAW$PrecursorMass & RAW$PrecursorMass < mz+eps)]
```

### Get Ms2 Scans


```{r}
plot.MS2Scans <- function (x, y, ...) 
{
    plot(x$mZ, x$intensity, type = "h", main = x$title, xlab = "m/Z", 
        ylab = "intensity", 
        sub=x$scanType,
        ...)
}



queryScannumbers <- sn[RAW$StartTime[sn] * 60 > 951 & RAW$StartTime[sn] * 60  < 961]
MS2Scans <- readScans(rawfile = rawfile, queryScannumbers)
#lapply(MS2Scans, plot.MS2Scans)
```

# 2019-03-26 
1415-1600 via Skype, FGCZ


## Implement getFragments method

```{r}
getFragments
```

example call
```{r}
df.frags <- getFragments("CC(C)(C)C(O)C(OC1=CC=C(Cl)C=C1)N1C=NC=N1", treeDepth = 2) 
```

### Plot in-silico spec
```{r in-silico, fig.retina=3}
plot(table(df.frags$mZ))
```


## Compute and Plot Matches

```{r matchPlot, fig.retina=3}
# table.df.frags <- table(df.frags$mZ)

library(protViz)
library(knitr)

write.csv(file='peaklist1.csv', data.frame(mZ=MS2Scans[[1]]$mZ, intensity=MS2Scans[[1]]$intensity), row.names = FALSE)

MS2Scans <- lapply(MS2Scans, function(x){rv <- x; idx <- x$intensity >0; x$mZ<-x$mZ[idx]; x$intensity <- x$intensity[idx]; x})


df.frags <- df.frags[!is.na(df.frags$mZ), ]

par(mar=c(6,6,6,2))
rv <- lapply(MS2Scans, function(x){
   plot(x$mZ, x$intensity,
        type = "h",
        main = x$title,
        xlab = "m/Z", 
        log='y',
        col='grey',
        # ylim=c(-max(x$intensity), max(x$intensity)),
        ylab = "intensity", 
        sub = x$scanType)
  
  # compute match
  idx.NN <- findNN(x$mZ, df.frags$mZ)
  
  error <- abs(x$mZ - df.frags$mZ[idx.NN])
  hits <- (error < 0.001)
  mZ.hits <- unique(df.frags$mZ[idx.NN[hits]])
  abline(v = mZ.hits, col=rgb(0.8,0.3,0.3, alpha = 0.4))
  
  
  axis(3, mZ.hits, round(mZ.hits,2))
  hit.idx <- idx.NN[hits]
  
  text(df.frags$mZ[hit.idx],
       rep(max(x$intensity)/2, length(hit.idx)),
       paste(df.frags$formula[hit.idx], df.frags$type[hit.idx], round(df.frags$mZ[hit.idx],2)),
       srt=90, pos=rep(c(2,1), length(hit.idx)/2), cex=0.4)
  
  hit.df <- df.frags[idx.NN[hits], ]
  
   print(kable(hit.df))
   hit.df
})
```